# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Contributor: Ray Donnelly <mingw.android@gmail.com>

pkgbase=msys2-runtime
pkgname=('msys2-runtime' 'msys2-runtime-devel')
pkgver=2.6.1
pkgrel=3
pkgdesc="Cygwin POSIX emulation engine"
arch=('i686' 'x86_64')
url="https://www.cygwin.com/"
license=('GPL')
groups=('base')
makedepends=('cocom'
             'texinfo'
             'git'
             'perl'
             'gcc'
             'make'
             'mingw-w64-cross-gcc'
             'mingw-w64-cross-zlib'
             'zlib-devel'
             'gettext-devel'
             'libiconv-devel'
             'diffutils')
# options=('debug' '!strip')
source=('msys2-runtime'::git://sourceware.org/git/newlib-cygwin.git#tag=cygwin-${pkgver//./_}-release
        0001-Add-MSYS-triplets.patch
        0002-Rename-DLL-from-cygwin-to-msys.patch
        0003-Add-functionality-for-converting-UNIX-paths-in-argum.patch
        0004-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
        0005-Move-root-to-usr.-Change-sorting-mount-points.-Do-no.patch
        0006-Do-not-create-cygwin-symlinks.-Instead-use-deep-copy.patch
        0007-Automatically-rewrite-TERM-msys-to-TERM-cygwin.patch
        0008-Do-not-convert-environment-for-strace.patch
        0009-convert-be-more-careful-to-stay-within-the-buffer.patch
        0010-convert-check-safely-whether-we-could-allocate-the-b.patch
        0011-convert-use-the-elegant-realloc-call.patch
        0012-convert-plug-potential-memory-leak.patch
        0013-convert-warn-when-we-cut-off-a-path.patch
        0014-arg_heuristic-be-better-prepared-to-handle-path-list.patch
        0015-Fix-converting-argument-looks-like-DVAR-str1-c-path1.patch
        0016-Special-case-for-converting-root-directory-to-have-t.patch
        0017-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
        0018-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
        0019-strace.cc-Don-t-set-MSYS-noglob.patch
        0020-Add-debugging-for-build_argv.patch
        0021-Add-debugging-for-strace-make_command_line.patch
        0022-environ.cc-New-facility-environment-variable-MSYS2_E.patch
        0023-path.cc-Ignore-zero-length-exclusions.patch
        0024-Pass-the-TZ-variable-to-non-msys-programs-if-it-is-s.patch
        0025-Pass-environment-variables-with-empty-values.patch
        0026-Handle-8-bit-characters-under-LOCALE-C.patch
        0027-Mention-the-extremely-useful-small_printf-function.patch
        0028-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
        0029-Do-not-add-a-trailing-slash-when-converting-to-a-Win.patch
        0030-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
        0031-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
        0032-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
        0033-Leave-Git-s-name-and-message-arguments-alone-please.patch
        0034-Leave-paths-containing-any-special-characters-alone.patch
        0035-Leave-paths-containing-alone.patch
        0036-Skip-posix-to-windows-conversion-when-is-seen.patch
        0037-Also-leave-Git-s-rev-.-name-syntax-alone.patch
        0038-Arguments-starting-with-are-no-paths.patch
        0039-Prevent-scp-style-arguments-from-being-mangled.patch
        0040-Fixed-path-converting-with-non-ascii-char.patch
        0041-path-conversion-Introduce-ability-to-switch-off-conv.patch
        0042-Kill-also-children-of-the-process-to-be-killed-via-C.patch
        0043-Export-the-kill_process_tree-function.patch
        0044-kill-Handle-Win32-console-processes-children-too.patch
        0045-Allow-overriding-the-home-directory-via-the-HOME-var.patch
        0046-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
        0047-Respect-the-db_home-env-setting-under-more-circumsta.patch
        0048-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
        0049-POSIX-ify-the-SHELL-variable.patch
        0050-Make-paths-WCS-MBS-conversion-explicit.patch
        0051-fixup-Add-functionality-for-converting-UNIX-paths-in.patch
        0052-FAST_CWD-adjust-the-initial-search-scope.patch
        0053-fixup-Rename-DLL-from-cygwin-to-msys.patch
        0054-fixup-Add-functionality-for-converting-UNIX-paths-in.patch
        0055-fixup-Add-functionality-for-converting-UNIX-paths-in.patch
        0056-fixup-Do-not-add-a-trailing-slash-when-converting-to.patch)
sha256sums=('SKIP'
            '8c73abe4ed22ed9793c8e68cf54a8f29bbdfa4c178aa2deb1d212d8bc16f4cb1'
            '672c17380e66017e704b9ee1235c08a6b6e6e45463351e8cef5f5023a0a80af2'
            '1ae2cb4ba69eff93d266e01b6155ed4cca6ee8de89d3c50f066f83376bd03f8e'
            '5a217773acce199ec0b9291397e95682cf4f300be8ef83178cbb8e07803ecbc5'
            '1a31706272327e1a6595c7d6444a5af4995aaa8c09899fc6e0467e6079b98840'
            'cba727133b8f926a4b9db526e52cd64d0a614e0334ab57f7923b32506bfdea3a'
            'cf7ee1edc10150ecdba3fd6cca9d842149f95e4def0b12aaa3c6f5aaa225dffa'
            '3254b36e11256a6b2f2091f6f7b832a82d32d7750b3df4fa9b255e024f60ab69'
            'd7ec42562f25d7bfd9916538cf9324301814496792d020cbf9c0769edeac16a7'
            '143fd241d4854a4ab2f747c711bd8bb64156e323aac0862f2b977a2492ea2cb2'
            '34cb77e20e4b36a4547b2e97e0eabefa89e3361bd39d327e11334e2a93a909a9'
            '7780d1d313330608609961ddbcb6b3c00b6b9b9ecd88ba5762dff361fd4c4137'
            '1c7a6571b3086935a4773d40875fb4999a52807172e90057c8bde01e7457f50e'
            '8024999b347ccfdbcb30f73152410c160632ea10b3da8da63b63d6b503f0a6ba'
            '291fecc43e305fcb68f793ed74e7c6afdc91cb2b44527c0409d29decfbdc64a6'
            '4cd808fc99dfa2914ca0cfb1e13ffbe75254295d1ad9b75ce6b690daa5cc66eb'
            '2165a06ee5e9ccc144de6b548b80a649611d289bcff1c60e5f0e2cd6c345b424'
            '8602263e5674ce44eda66e146ebe59adbdc184f9cc57dbf6df636cf4978998a0'
            '4d6289e6de2c86c701aea7ad67eb4410fb8a972592a857271fd0c728a98ae753'
            '102ed680d2d52f27a331180a6e81ef27136a69e7b5df249f58b50e8b72fd2621'
            '1afb829bd2af196e2f02c7febf4a8f545f9c891eb5fe00d7d701fe569e7dbb85'
            'c89d2f027b790b6f2ababc81ea8661013b16c45151a72be6e9fd2dd0d3dd82e6'
            '87b82d643ece2526d1866cf82179b5518c41cfbb358872d128701978748f8585'
            'c48680d4e10cedf2ffc5c7ca60c30e54dae0d276b36ec0ce03ee2a38999d7e28'
            '2d7a625fa985952c9f119529826ab298a29244758c6d8e2e44b10ab192742754'
            '6d42dd1d1943e29507fe28e8393f604fe51e628ca2de765c6fa03ac10b438087'
            'ef4999a8b2c1d3bf58a4e1c6da91b11e439bfd5417388fb4350bdacbf7af8c3b'
            '2ec92b037e7581d8ebb17bb21895df3c8cfc3cb9ccca427575fab1077f043826'
            'f9b9adef2e5f22364c749c87918aba907a6e4f38adbf5f94c4ec47b798450e2f'
            'beb0b89febad5538175758a50e7c37afb4740b037b0444f644264111a93308e7'
            '13b999d848867081153d17c271f0978f57d2060cfba43254e7c84aafe1ece812'
            '3bb58ab4c97151dccc6a1143c89881ce2fabacded134bd3deb202efccc2e70db'
            '99ef6e53ccc2082e544249e92821ec8c848e3356d6b195ab00aa9b0ef238b19e'
            '72552ec2a5baaddef3e0abf2128187d2cc158200e2c13823a54a5ac37cb2d821'
            'efec5817f626c76b2588b818e064091b7935548b044ab4a24a6338b416173a69'
            'e70f0ca57aba4b2a26c17d26b0395af9107376d875cd286ea5b4f074e84070fa'
            '377f8fb591da3c8c66f8104adfe7c63ca2006416a942b6c1580d21a1bd9869b9'
            'faba3856e0d9f63db05d2963a978e195ad90ce7bbbba796ee4dfaf4ae19aa7aa'
            'f02b7f355c1dadbf0eefa450d7ef6e167988a201ae15470f015b465db70011d9'
            'f8c4126c076be84022f4ef14c65c775e794686a8994c20ad5c5560fc4ceffb84'
            'c5e4210a0be45ee4a8fc67f1f7fd83a7a3fddaff3191446336601daf78dfa5a2'
            '0a828a0b9a89360b4e3bce7339fbf6798f00012a656033e6d7f9381883f7a949'
            '32ca85b8fe7eb841e8ff0be119665a913ae68fe3a3afb161bd994f4f053f42f8'
            'bcb5b1ce84a14ba7b877495702c8a0a331df7e43d41afb3a6c7b4ddfcf5b2493'
            '349b8fa25ac099a5dc584b6780983a124a30ed789a0e45e2838f3a96f994900d'
            '8c5c61c243f9db0dabe41a3f9a5bd612c4b6ea3a51fb082ca59a645a525ea5fb'
            '736b38e678cca7815bd3ae7049bfa1302de608bf373d5238f131fae79adad2c3'
            '8935f169d9ad60bd81fc0b58530b2b804626d272e53a4953b83a8bd0612166de'
            '0e91d40daf8939ad03ffb6f4f9a468dfdc668bb0eedd6a000203bb426312099f'
            '3134bcf000cf8cd4ef1820f15a9436ed4812b96d89742e1f630677b03fcb7612'
            'd58b67ef06b4051250076cfe7289fdbbcb60df15f7a3300d6694ae80059e835b'
            '7b529c2d0a20553f47bdd6e166a70eca707afd2339231179aa745faa4485bbe4'
            '180a889f736a5d90d85e15040a152f0f5825144c3d9a8c384b367ee634aeb351'
            '8e08490828a5247f1f8cfe7b804369f9df5b2e2433085ce22fc129eaefd84888'
            '610d1f786531081392095e18930d53beb0f516aa8c7e79f1be6b9c2a19e63a05'
            '616efb0f4e1293cd882445137eca939d9b6f1993e813758b63e1ffc654f8256a')
prepare() {
  cd "${srcdir}"/msys2-runtime
  git am --committer-date-is-author-date "${srcdir}"/0001-Add-MSYS-triplets.patch
  git am --committer-date-is-author-date "${srcdir}"/0002-Rename-DLL-from-cygwin-to-msys.patch
  git am --committer-date-is-author-date "${srcdir}"/0003-Add-functionality-for-converting-UNIX-paths-in-argum.patch
  git am --committer-date-is-author-date "${srcdir}"/0004-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
  git am --committer-date-is-author-date "${srcdir}"/0005-Move-root-to-usr.-Change-sorting-mount-points.-Do-no.patch
  git am --committer-date-is-author-date "${srcdir}"/0006-Do-not-create-cygwin-symlinks.-Instead-use-deep-copy.patch
  git am --committer-date-is-author-date "${srcdir}"/0007-Automatically-rewrite-TERM-msys-to-TERM-cygwin.patch
  git am --committer-date-is-author-date "${srcdir}"/0008-Do-not-convert-environment-for-strace.patch
  git am --committer-date-is-author-date "${srcdir}"/0009-convert-be-more-careful-to-stay-within-the-buffer.patch
  git am --committer-date-is-author-date "${srcdir}"/0010-convert-check-safely-whether-we-could-allocate-the-b.patch
  git am --committer-date-is-author-date "${srcdir}"/0011-convert-use-the-elegant-realloc-call.patch
  git am --committer-date-is-author-date "${srcdir}"/0012-convert-plug-potential-memory-leak.patch
  git am --committer-date-is-author-date "${srcdir}"/0013-convert-warn-when-we-cut-off-a-path.patch
  git am --committer-date-is-author-date "${srcdir}"/0014-arg_heuristic-be-better-prepared-to-handle-path-list.patch
  git am --committer-date-is-author-date "${srcdir}"/0015-Fix-converting-argument-looks-like-DVAR-str1-c-path1.patch
  git am --committer-date-is-author-date "${srcdir}"/0016-Special-case-for-converting-root-directory-to-have-t.patch
  git am --committer-date-is-author-date "${srcdir}"/0017-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
  git am --committer-date-is-author-date "${srcdir}"/0018-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
  git am --committer-date-is-author-date "${srcdir}"/0019-strace.cc-Don-t-set-MSYS-noglob.patch
  git am --committer-date-is-author-date "${srcdir}"/0020-Add-debugging-for-build_argv.patch
  git am --committer-date-is-author-date "${srcdir}"/0021-Add-debugging-for-strace-make_command_line.patch
  git am --committer-date-is-author-date "${srcdir}"/0022-environ.cc-New-facility-environment-variable-MSYS2_E.patch
  git am --committer-date-is-author-date "${srcdir}"/0023-path.cc-Ignore-zero-length-exclusions.patch
  git am --committer-date-is-author-date "${srcdir}"/0024-Pass-the-TZ-variable-to-non-msys-programs-if-it-is-s.patch
  git am --committer-date-is-author-date "${srcdir}"/0025-Pass-environment-variables-with-empty-values.patch
  git am --committer-date-is-author-date "${srcdir}"/0026-Handle-8-bit-characters-under-LOCALE-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0027-Mention-the-extremely-useful-small_printf-function.patch
  git am --committer-date-is-author-date "${srcdir}"/0028-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
  git am --committer-date-is-author-date "${srcdir}"/0029-Do-not-add-a-trailing-slash-when-converting-to-a-Win.patch
  git am --committer-date-is-author-date "${srcdir}"/0030-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
  git am --committer-date-is-author-date "${srcdir}"/0031-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
  git am --committer-date-is-author-date "${srcdir}"/0032-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0033-Leave-Git-s-name-and-message-arguments-alone-please.patch
  git am --committer-date-is-author-date "${srcdir}"/0034-Leave-paths-containing-any-special-characters-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0035-Leave-paths-containing-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0036-Skip-posix-to-windows-conversion-when-is-seen.patch
  git am --committer-date-is-author-date "${srcdir}"/0037-Also-leave-Git-s-rev-.-name-syntax-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0038-Arguments-starting-with-are-no-paths.patch
  git am --committer-date-is-author-date "${srcdir}"/0039-Prevent-scp-style-arguments-from-being-mangled.patch
  git am --committer-date-is-author-date "${srcdir}"/0040-Fixed-path-converting-with-non-ascii-char.patch
  git am --committer-date-is-author-date "${srcdir}"/0041-path-conversion-Introduce-ability-to-switch-off-conv.patch
  git am --committer-date-is-author-date "${srcdir}"/0042-Kill-also-children-of-the-process-to-be-killed-via-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0043-Export-the-kill_process_tree-function.patch
  git am --committer-date-is-author-date "${srcdir}"/0044-kill-Handle-Win32-console-processes-children-too.patch
  git am --committer-date-is-author-date "${srcdir}"/0045-Allow-overriding-the-home-directory-via-the-HOME-var.patch
  git am --committer-date-is-author-date "${srcdir}"/0046-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
  git am --committer-date-is-author-date "${srcdir}"/0047-Respect-the-db_home-env-setting-under-more-circumsta.patch
  git am --committer-date-is-author-date "${srcdir}"/0048-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
  git am --committer-date-is-author-date "${srcdir}"/0049-POSIX-ify-the-SHELL-variable.patch
  git am --committer-date-is-author-date "${srcdir}"/0050-Make-paths-WCS-MBS-conversion-explicit.patch
  git am --committer-date-is-author-date "${srcdir}"/0051-fixup-Add-functionality-for-converting-UNIX-paths-in.patch
  git am --committer-date-is-author-date "${srcdir}"/0052-FAST_CWD-adjust-the-initial-search-scope.patch
  git am --committer-date-is-author-date "${srcdir}"/0053-fixup-Rename-DLL-from-cygwin-to-msys.patch
  git am --committer-date-is-author-date "${srcdir}"/0054-fixup-Add-functionality-for-converting-UNIX-paths-in.patch
  git am --committer-date-is-author-date "${srcdir}"/0055-fixup-Add-functionality-for-converting-UNIX-paths-in.patch
  git am --committer-date-is-author-date "${srcdir}"/0056-fixup-Do-not-add-a-trailing-slash-when-converting-to.patch
}

build() {
  [[ -d "${srcdir}"/build-${CHOST} ]] && rm -rf "${srcdir}"/build-${CHOST}
  mkdir -p "${srcdir}"/build-${CHOST} && cd "${srcdir}"/build-${CHOST}

  # Gives more verbose compile output when debugging.
  local -a extra_config
  if check_option "debug" "y"; then
    export CCWRAP_VERBOSE=1
    OPTIM="-O0"
    extra_config+=(--enable-debugging)
  else
    OPTIM="-O2"
  fi

  CFLAGS="$OPTIM -pipe -ggdb"
  CXXFLAGS="$OPTIM -pipe -ggdb"

  "${srcdir}"/msys2-runtime/configure \
    --prefix=/usr \
    --build=${CHOST} \
    --sysconfdir=/etc \
    "${extra_config[@]}"
  LC_ALL=C make
  LC_ALL=C make -j1 DESTDIR="${srcdir}"/dest install

  #pushd ${CHOST}/winsup/cygwin > /dev/null
  #LANG=C make libmsys2_s.a
  #cp libmsys2_s.a "${srcdir}"/dest/usr/${CHOST}/lib/
  #popd > /dev/null

  rm -rf "${srcdir}"/dest/etc
}

package_msys2-runtime() {
  pkgdesc="Posix emulation engine for Windows"
  groups=('base')
  options=('!strip')
  #install=msys2-runtime.install

  mkdir -p "${pkgdir}"/usr
  cp -rf "${srcdir}"/dest/usr/bin "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/bin/msys-2.0.dbg
  rm -f "${pkgdir}"/usr/bin/cyglsa-config
  rm -f "${pkgdir}"/usr/bin/cyglsa.dll
  rm -f "${pkgdir}"/usr/bin/cyglsa64.dll
  rm -f "${pkgdir}"/usr/bin/cygserver-config
  cp -rf "${srcdir}"/dest/usr/share "${pkgdir}"/usr/
}

package_msys2-runtime-devel() {
  pkgdesc="MSYS2 headers and libraries"
  groups=('MSYS2-devel')
  depends=("msys2-runtime=${pkgver}")
  options=('staticlibs' '!strip')

  mkdir -p "${pkgdir}"/usr/bin
  cp -f "${srcdir}"/dest/usr/bin/msys-2.0.dbg "${pkgdir}"/usr/bin/
  cp -rLf "${srcdir}"/dest/usr/${CHOST}/include "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/include/iconv.h
  rm -f "${pkgdir}"/usr/include/unctrl.h
  # provided by libtirpc
  rm -fr "${pkgdir}"/usr/include/rpc/

  cp -rLf "${srcdir}"/dest/usr/${CHOST}/lib "${pkgdir}"/usr/
}

# return 0
# To hack on this:
# cd /c/repo-MSYS2/msys2-runtime/
# pushd src/build-i686-pc-msys
# LANG=C make && make -j1 DESTDIR=/c/repo-MSYS2/msys2-runtime/src/dest install
# popd
# makepkg -sRLf
# pacman -U msys2-runtime*.xz

# Quicker:
# open cmd.exe
# set "PATH=C:\\msys32\\usr\\bin;%PATH%"
# E:
# pushd E:\m2\repo-MSYS2\msys2-runtime\src\build-i686-pc-msys\i686-pc-msys\winsup\cygwin
# C:/msys32/usr/bin/bash -c "LANG=C && make"
# copy /y new-msys-2.0.dll C:\msys32\usr\bin\msys-2.0.dll
# popd
# C:
# C:/msys32/usr/bin/strace ls / > C:/strace.txt 2>&1
#
