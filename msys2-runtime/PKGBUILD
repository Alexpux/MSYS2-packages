# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Contributor: Ray Donnelly <mingw.android@gmail.com>

pkgbase=msys2-runtime
pkgname=('msys2-runtime' 'msys2-runtime-devel')
pkgver=2.8.0pre1
pkgrel=2
pkgdesc="Cygwin POSIX emulation engine"
arch=('i686' 'x86_64')
url="https://www.cygwin.com/"
license=('GPL')
groups=('base')
makedepends=('cocom'
             'texinfo'
             'git'
             'perl'
             'gcc'
             'make'
             'mingw-w64-cross-gcc'
             'mingw-w64-cross-zlib'
             'zlib-devel'
             'gettext-devel'
             'libiconv-devel'
             'diffutils')
# options=('debug' '!strip')
source=('msys2-runtime'::git://sourceware.org/git/newlib-cygwin.git#commit=33c7b2b544a96ee443728f9558ce07a13e05f1e8
        0001-Add-MSYS-triplets.patch
        0002-Rename-DLL-from-cygwin-to-msys.patch
        0003-Add-functionality-for-converting-UNIX-paths-in-argum.patch
        0004-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
        0005-Move-root-to-usr.-Change-sorting-mount-points.-Do-no.patch
        0006-Do-not-create-cygwin-symlinks.-Instead-use-deep-copy.patch
        0007-Automatically-rewrite-TERM-msys-to-TERM-cygwin.patch
        0008-Do-not-convert-environment-for-strace.patch
        0009-convert-be-more-careful-to-stay-within-the-buffer.patch
        0010-convert-check-safely-whether-we-could-allocate-the-b.patch
        0011-convert-use-the-elegant-realloc-call.patch
        0012-convert-plug-potential-memory-leak.patch
        0013-convert-warn-when-we-cut-off-a-path.patch
        0014-arg_heuristic-be-better-prepared-to-handle-path-list.patch
        0015-Fix-converting-argument-looks-like-DVAR-str1-c-path1.patch
        0016-Special-case-for-converting-root-directory-to-have-t.patch
        0017-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
        0018-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
        0019-strace.cc-Don-t-set-MSYS-noglob.patch
        0020-Add-debugging-for-build_argv.patch
        0021-Add-debugging-for-strace-make_command_line.patch
        0022-environ.cc-New-facility-environment-variable-MSYS2_E.patch
        0023-path.cc-Ignore-zero-length-exclusions.patch
        0024-Pass-the-TZ-variable-to-non-msys-programs-if-it-is-s.patch
        0025-Pass-environment-variables-with-empty-values.patch
        0026-Handle-8-bit-characters-under-LOCALE-C.patch
        0027-Mention-the-extremely-useful-small_printf-function.patch
        0028-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
        0029-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
        0030-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
        0031-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
        0032-Leave-Git-s-name-and-message-arguments-alone-please.patch
        0033-Leave-paths-containing-any-special-characters-alone.patch
        0034-Leave-paths-containing-alone.patch
        0035-Skip-posix-to-windows-conversion-when-is-seen.patch
        0036-Also-leave-Git-s-rev-.-name-syntax-alone.patch
        0037-Arguments-starting-with-are-no-paths.patch
        0038-Prevent-scp-style-arguments-from-being-mangled.patch
        0039-Fixed-path-converting-with-non-ascii-char.patch
        0040-path-conversion-Introduce-ability-to-switch-off-conv.patch
        0041-Kill-also-children-of-the-process-to-be-killed-via-C.patch
        0042-Export-the-kill_process_tree-function.patch
        0043-kill-Handle-Win32-console-processes-children-too.patch
        0044-Allow-overriding-the-home-directory-via-the-HOME-var.patch
        0045-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
        0046-Respect-the-db_home-env-setting-under-more-circumsta.patch
        0047-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
        0048-POSIX-ify-the-SHELL-variable.patch
        0049-Make-paths-WCS-MBS-conversion-explicit.patch
        0050-Handle-ORIGINAL_PATH-just-like-PATH.patch)
sha256sums=('SKIP'
            '2a26ad1f1af44bf32247fc790c153c4459a71c333f17f41e63c6c3d25382b45e'
            '9b509f4926fbb64e7ff3acf5200d34568876cba6f61d7e46bb8030cb69cb3f26'
            '9e9af88c5b17003e309ecf583da2cad6f8df51af5dc17e1863ea6717fc9c9bca'
            'e0d5a2f693a1000f2217eae9a38163391a81c1aafd6c6e8997fb0413b7ba69f3'
            'ee6267ed3811c1eb11f3550f3c5cb8c7a0c33c1da6426c35352d5b7bb0f91abc'
            '8be6e28c4669873c2d0f1107275584aa9cd1603649043900f2d9aca298dea98d'
            '7af26e86ee3df231820f6cf2528f9e28e2914fbf7e69854e45addd63f1c8da2f'
            '916178c3f25d3777ee41b9b4a991aed28485dd6e9d166c564f29c7a5f06b9e1f'
            'e411dbc8356d325341baa0d6ad5258a8df4595196301fd5e270fd5083364d813'
            'a1dce57340d8bbdaa057e84c309375d921ef8fb3815d04250c106c6265610c0c'
            '556b0e58a12b254d6a3b5a887bbd48a6265c13864449119d33ed03fcf99b71ff'
            'ebf70baa5bdb371466cc1d6aeb34d327717db6e2613bbbc7801779a50b09a580'
            '0d64ef18324c0d702243241b7ed35f55bccd7269ac39d280e3ecc51a35d4d727'
            'ef3ac9ec5341943e0f433e8dac21784ef9db148a5dd854edc53f365b141d77ee'
            'adb921eaf50d6da95d8a1aeec918171f0f6ecd8af21cacbe6dc505f206d37680'
            '4aa0b7af0c086e4fe6f9759dd86daf6a29108e6f5f1c0a4b834ba35278286b5e'
            '3d8647706912540860d4754c9b29ab2ec52cf0afa70dabb90dc9c90640233874'
            '29af1feac0df5537a393980478aabe6ec9c84d5b7336640c190323d0c05d5fb6'
            '179fc3be6903932b8c19350b205138529ed5163acc133e0f33d81b32e8ea38cd'
            '553309581c830bd3f9535ef596111c11237ea69e17727accc8cf7fb46f8de97c'
            '768531e1ff41aa041064c993938dbfa54301290172cef5891f289c773022531b'
            'c0d33b3fe415b178c895b398e5088c5d75cc8c6a83e7de8664e75c9465b7b28f'
            '3a058677ad448a40b4d51c68a99d5803c611bccac35b17c2a3638c469193bfe4'
            '26f09046081da62ddb03b21be8a06c68e80a4572d170b33b2368210367736843'
            'e40f60a61f3a2427551e8921b0728102b5ceb055b46b9e89fd3f179af7de3467'
            '0b9ba4301b86a759d58d7980dc49a83d98d9d13a1fd7797b68ebcdfedeaa9050'
            '620313c0c1a1f23cdde435d9ba10e6bacfb77d5a7fa98db72f824cbe60a242c1'
            '3c575f2ae0ecf77b380cf79b76ac1d636ec03a7d09316c5922b1a6150a12ebcf'
            'ca385c5e8b062caa7a7a96705d391027e74b76ea8995bf4dec69b52c8ed6f3d2'
            'bc668b331bb451ea1ae6fea9f8ededec403d3fcff79995c4dda489c255c36db0'
            '22e27db445323609ba92af4289e06ce3e963d1433e4e943da4bd89ecbf538f27'
            'cc0365fd4ccbce6331bb9054374b594ce670b620fd4db8e9b4d0db7c0ac0a49d'
            'c214148479d3d5480ba6557f7250c6d5282a565e7aaec08c34a94e618673fc61'
            '170562a887d0aa9a9ac95192dafa47695d45331f38cbb391cb035c414d939133'
            '41a328f16f5107f89af9005c16e8500777a4274cd22e6cbeb240ed41d8a4c960'
            'fcbfd7b3fc9833b5921fa021b678406a0cc6100627db109be93a48b55376cd99'
            '4736efc6a5f6dfbe2c2b50fd3114a6b91eb4946b7c58a8b0ab74c4430685df96'
            '5e84c49fd6bc332d8280e5c8d20298b90ecdc9eb2c3e548a995f0c3db3a37287'
            '84f5e4f72c7a642b14038155776ff1f4afd65038cad058db409523cfdafedf2e'
            '9880c7e780956afdebd850add014c1e7694d4953508d9ec445d9f6385c34baac'
            'e33da90eb5f8115fc88863bdccfaf33d6b18ffbbbdfb6108ac39a2157c2a3cc3'
            '0e4769a1a52faaf57ebc094c7c14e6fe9a3cd8702b37d0295de8efeb59dc4b4a'
            '1860dec829c15c0a6b18606338e3feff9091cc50ea727be8e7df3b76a0bd19a2'
            'e1ee6a697da4c4d4d3e631f05aeecab59ad2fe0dde081a591bfaa8df1867382c'
            'e4704e59588353aeb4f5b81c199e9a313438e91640b3293ecc535258bb999219'
            'e97300318d5423abef1832c657e0a7800515a59b81abb4b55a77780af8ef6725'
            'a8574e60827de7509661a72cc1880b4f67f0caef149f932bc7fd2729cb875c1a'
            '0ff3b6f5c1673f42725edd937be8a2c473716bb2282d2b7818a5814b6aeed06e'
            'dfa6a7f6aee3ce268baf4ed8bf7a3ee4b89942eef4c8cc161dd2efc25d64224c'
            '96916dd8296c4792f7752c4d65c3651d02b1d9719784c212b546725c13e6436d')
prepare() {
  cd "${srcdir}"/msys2-runtime
  git am --committer-date-is-author-date "${srcdir}"/0001-Add-MSYS-triplets.patch
  git am --committer-date-is-author-date "${srcdir}"/0002-Rename-DLL-from-cygwin-to-msys.patch
  git am --committer-date-is-author-date "${srcdir}"/0003-Add-functionality-for-converting-UNIX-paths-in-argum.patch
  git am --committer-date-is-author-date "${srcdir}"/0004-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
  git am --committer-date-is-author-date "${srcdir}"/0005-Move-root-to-usr.-Change-sorting-mount-points.-Do-no.patch
  git am --committer-date-is-author-date "${srcdir}"/0006-Do-not-create-cygwin-symlinks.-Instead-use-deep-copy.patch
  git am --committer-date-is-author-date "${srcdir}"/0007-Automatically-rewrite-TERM-msys-to-TERM-cygwin.patch
  git am --committer-date-is-author-date "${srcdir}"/0008-Do-not-convert-environment-for-strace.patch
  git am --committer-date-is-author-date "${srcdir}"/0009-convert-be-more-careful-to-stay-within-the-buffer.patch
  git am --committer-date-is-author-date "${srcdir}"/0010-convert-check-safely-whether-we-could-allocate-the-b.patch
  git am --committer-date-is-author-date "${srcdir}"/0011-convert-use-the-elegant-realloc-call.patch
  git am --committer-date-is-author-date "${srcdir}"/0012-convert-plug-potential-memory-leak.patch
  git am --committer-date-is-author-date "${srcdir}"/0013-convert-warn-when-we-cut-off-a-path.patch
  git am --committer-date-is-author-date "${srcdir}"/0014-arg_heuristic-be-better-prepared-to-handle-path-list.patch
  git am --committer-date-is-author-date "${srcdir}"/0015-Fix-converting-argument-looks-like-DVAR-str1-c-path1.patch
  git am --committer-date-is-author-date "${srcdir}"/0016-Special-case-for-converting-root-directory-to-have-t.patch
  git am --committer-date-is-author-date "${srcdir}"/0017-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
  git am --committer-date-is-author-date "${srcdir}"/0018-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
  git am --committer-date-is-author-date "${srcdir}"/0019-strace.cc-Don-t-set-MSYS-noglob.patch
  git am --committer-date-is-author-date "${srcdir}"/0020-Add-debugging-for-build_argv.patch
  git am --committer-date-is-author-date "${srcdir}"/0021-Add-debugging-for-strace-make_command_line.patch
  git am --committer-date-is-author-date "${srcdir}"/0022-environ.cc-New-facility-environment-variable-MSYS2_E.patch
  git am --committer-date-is-author-date "${srcdir}"/0023-path.cc-Ignore-zero-length-exclusions.patch
  git am --committer-date-is-author-date "${srcdir}"/0024-Pass-the-TZ-variable-to-non-msys-programs-if-it-is-s.patch
  git am --committer-date-is-author-date "${srcdir}"/0025-Pass-environment-variables-with-empty-values.patch
  git am --committer-date-is-author-date "${srcdir}"/0026-Handle-8-bit-characters-under-LOCALE-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0027-Mention-the-extremely-useful-small_printf-function.patch
  git am --committer-date-is-author-date "${srcdir}"/0028-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
  git am --committer-date-is-author-date "${srcdir}"/0029-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
  git am --committer-date-is-author-date "${srcdir}"/0030-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
  git am --committer-date-is-author-date "${srcdir}"/0031-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0032-Leave-Git-s-name-and-message-arguments-alone-please.patch
  git am --committer-date-is-author-date "${srcdir}"/0033-Leave-paths-containing-any-special-characters-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0034-Leave-paths-containing-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0035-Skip-posix-to-windows-conversion-when-is-seen.patch
  git am --committer-date-is-author-date "${srcdir}"/0036-Also-leave-Git-s-rev-.-name-syntax-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0037-Arguments-starting-with-are-no-paths.patch
  git am --committer-date-is-author-date "${srcdir}"/0038-Prevent-scp-style-arguments-from-being-mangled.patch
  git am --committer-date-is-author-date "${srcdir}"/0039-Fixed-path-converting-with-non-ascii-char.patch
  git am --committer-date-is-author-date "${srcdir}"/0040-path-conversion-Introduce-ability-to-switch-off-conv.patch
  git am --committer-date-is-author-date "${srcdir}"/0041-Kill-also-children-of-the-process-to-be-killed-via-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0042-Export-the-kill_process_tree-function.patch
  git am --committer-date-is-author-date "${srcdir}"/0043-kill-Handle-Win32-console-processes-children-too.patch
  git am --committer-date-is-author-date "${srcdir}"/0044-Allow-overriding-the-home-directory-via-the-HOME-var.patch
  git am --committer-date-is-author-date "${srcdir}"/0045-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
  git am --committer-date-is-author-date "${srcdir}"/0046-Respect-the-db_home-env-setting-under-more-circumsta.patch
  git am --committer-date-is-author-date "${srcdir}"/0047-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
  git am --committer-date-is-author-date "${srcdir}"/0048-POSIX-ify-the-SHELL-variable.patch
  git am --committer-date-is-author-date "${srcdir}"/0049-Make-paths-WCS-MBS-conversion-explicit.patch
  git am --committer-date-is-author-date "${srcdir}"/0050-Handle-ORIGINAL_PATH-just-like-PATH.patch
}

build() {
  [[ -d "${srcdir}"/build-${CHOST} ]] && rm -rf "${srcdir}"/build-${CHOST}
  mkdir -p "${srcdir}"/build-${CHOST} && cd "${srcdir}"/build-${CHOST}

  # Gives more verbose compile output when debugging.
  local -a extra_config
  if check_option "debug" "y"; then
    export CCWRAP_VERBOSE=1
    OPTIM="-O0"
    extra_config+=(--enable-debugging)
  else
    OPTIM="-O2"
  fi

  CFLAGS="$OPTIM -pipe -ggdb -Wno-error=frame-address -fno-delete-null-pointer-checks"
  CXXFLAGS="$OPTIM -pipe -ggdb -Wno-error=frame-address -fno-delete-null-pointer-checks"

  "${srcdir}"/msys2-runtime/configure \
    --prefix=/usr \
    --build=${CHOST} \
    --sysconfdir=/etc \
    "${extra_config[@]}"
  LC_ALL=C make
  LC_ALL=C make -j1 DESTDIR="${srcdir}"/dest install

  #pushd ${CHOST}/winsup/cygwin > /dev/null
  #LANG=C make libmsys2_s.a
  #cp libmsys2_s.a "${srcdir}"/dest/usr/${CHOST}/lib/
  #popd > /dev/null

  rm -rf "${srcdir}"/dest/etc
}

package_msys2-runtime() {
  pkgdesc="Posix emulation engine for Windows"
  groups=('base')
  options=('!strip')
  #install=msys2-runtime.install

  mkdir -p "${pkgdir}"/usr
  cp -rf "${srcdir}"/dest/usr/bin "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/bin/msys-2.0.dbg
  rm -f "${pkgdir}"/usr/bin/cyglsa-config
  rm -f "${pkgdir}"/usr/bin/cyglsa.dll
  rm -f "${pkgdir}"/usr/bin/cyglsa64.dll
  rm -f "${pkgdir}"/usr/bin/cygserver-config
  cp -rf "${srcdir}"/dest/usr/share "${pkgdir}"/usr/
}

package_msys2-runtime-devel() {
  pkgdesc="MSYS2 headers and libraries"
  groups=('MSYS2-devel')
  depends=("msys2-runtime=${pkgver}")
  options=('staticlibs' '!strip')

  mkdir -p "${pkgdir}"/usr/bin
  cp -f "${srcdir}"/dest/usr/bin/msys-2.0.dbg "${pkgdir}"/usr/bin/
  cp -rLf "${srcdir}"/dest/usr/${CHOST}/include "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/include/iconv.h
  rm -f "${pkgdir}"/usr/include/unctrl.h
  # provided by libtirpc
  rm -fr "${pkgdir}"/usr/include/rpc/

  cp -rLf "${srcdir}"/dest/usr/${CHOST}/lib "${pkgdir}"/usr/
}

# return 0
# To hack on this:
# cd /c/repo-MSYS2/msys2-runtime/
# pushd src/build-i686-pc-msys
# LANG=C make && make -j1 DESTDIR=/c/repo-MSYS2/msys2-runtime/src/dest install
# popd
# makepkg -sRLf
# pacman -U msys2-runtime*.xz

# Quicker:
# open cmd.exe
# set "PATH=C:\\msys32\\usr\\bin;%PATH%"
# E:
# pushd E:\m2\repo-MSYS2\msys2-runtime\src\build-i686-pc-msys\i686-pc-msys\winsup\cygwin
# C:/msys32/usr/bin/bash -c "LANG=C && make"
# copy /y new-msys-2.0.dll C:\msys32\usr\bin\msys-2.0.dll
# popd
# C:
# C:/msys32/usr/bin/strace ls / > C:/strace.txt 2>&1
#
