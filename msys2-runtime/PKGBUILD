# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Contributor: Ray Donnelly <mingw.android@gmail.com>

pkgbase=msys2-runtime
pkgname=('msys2-runtime' 'msys2-runtime-devel')
pkgver=2.8.0
pkgrel=1
pkgdesc="Cygwin POSIX emulation engine"
arch=('i686' 'x86_64')
url="https://www.cygwin.com/"
license=('GPL')
groups=('base')
makedepends=('cocom'
             'texinfo'
             'git'
             'perl'
             'gcc'
             'make'
             'mingw-w64-cross-gcc'
             'mingw-w64-cross-zlib'
             'zlib-devel'
             'gettext-devel'
             'libiconv-devel'
             'diffutils')
# options=('debug' '!strip')
source=('msys2-runtime'::git://sourceware.org/git/newlib-cygwin.git#tag=cygwin-${pkgver//./_}-release
        0001-Add-MSYS-triplets.patch
        0002-Rename-DLL-from-cygwin-to-msys.patch
        0003-Add-functionality-for-converting-UNIX-paths-in-argum.patch
        0004-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
        0005-Move-root-to-usr.-Change-sorting-mount-points.-Do-no.patch
        0006-Do-not-create-cygwin-symlinks.-Instead-use-deep-copy.patch
        0007-Automatically-rewrite-TERM-msys-to-TERM-cygwin.patch
        0008-Do-not-convert-environment-for-strace.patch
        0009-convert-be-more-careful-to-stay-within-the-buffer.patch
        0010-convert-check-safely-whether-we-could-allocate-the-b.patch
        0011-convert-use-the-elegant-realloc-call.patch
        0012-convert-plug-potential-memory-leak.patch
        0013-convert-warn-when-we-cut-off-a-path.patch
        0014-arg_heuristic-be-better-prepared-to-handle-path-list.patch
        0015-Fix-converting-argument-looks-like-DVAR-str1-c-path1.patch
        0016-Special-case-for-converting-root-directory-to-have-t.patch
        0017-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
        0018-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
        0019-strace.cc-Don-t-set-MSYS-noglob.patch
        0020-Add-debugging-for-build_argv.patch
        0021-Add-debugging-for-strace-make_command_line.patch
        0022-environ.cc-New-facility-environment-variable-MSYS2_E.patch
        0023-Pass-the-TZ-variable-to-non-msys-programs-if-it-is-s.patch
        0024-Pass-environment-variables-with-empty-values.patch
        0025-Handle-8-bit-characters-under-LOCALE-C.patch
        0026-path.cc-Ignore-zero-length-exclusions.patch
        0027-Mention-the-extremely-useful-small_printf-function.patch
        0028-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
        0029-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
        0030-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
        0031-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
        0032-Leave-Git-s-name-and-message-arguments-alone-please.patch
        0033-Leave-paths-containing-any-special-characters-alone.patch
        0034-Leave-paths-containing-alone.patch
        0035-Skip-posix-to-windows-conversion-when-is-seen.patch
        0036-Also-leave-Git-s-rev-.-name-syntax-alone.patch
        0037-Arguments-starting-with-are-no-paths.patch
        0038-Prevent-scp-style-arguments-from-being-mangled.patch
        0039-Fixed-path-converting-with-non-ascii-char.patch
        0040-path-conversion-Introduce-ability-to-switch-off-conv.patch
        0041-Kill-also-children-of-the-process-to-be-killed-via-C.patch
        0042-Export-the-kill_process_tree-function.patch
        0043-kill-Handle-Win32-console-processes-children-too.patch
        0044-Allow-overriding-the-home-directory-via-the-HOME-var.patch
        0045-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
        0046-Respect-the-db_home-env-setting-under-more-circumsta.patch
        0047-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
        0048-POSIX-ify-the-SHELL-variable.patch
        0049-Make-paths-WCS-MBS-conversion-explicit.patch
        0050-Handle-ORIGINAL_PATH-just-like-PATH.patch)
sha256sums=('SKIP'
            'e252d33b2ad9ffaa80e8d1305fb57db9c96604ed2a073a5c87ebf1d9826cc866'
            '0c6bfe29e5f04c0428c6c572b0028c9edc5720cf60734b97745f1d1cfc9f1a7f'
            '14d34b22159b1eb3b4285f03317b5889c32f25a3a6ac80dd959b064ec10dacff'
            'fb0bdd54ff5760516432e8bd6f1b8338e2e8f15eb642f929711f91e179022ad1'
            '43d35ce5ad990a9a04a18846bc44878c1f8dad759b82aa919bec6a3b50fad489'
            '3d2f19b48393135dbda74137164fd79b43631efbaea3f2d446a1e08cb3aa845c'
            '945274ecf962e246f416793d12185ecf31d2a1f5a0d22aaa7b14c29bc425a6a1'
            '56188e0d34b6777c1ede477a6e529523ce97e6f8e6cf317cefc00843f5130f06'
            'b4735ddac005a0c2185a1d82f0c88fb77ef7eff553c0935c3c93f5689d3000e3'
            'bf69484fd6fe94048f7d7635f1e009e5a65eb4d836fca0d4b2a6dec4bcfd64ae'
            'afcf9abf2816aaaf96c8f562549daddabc5103c825dc4147a30f8a6694503208'
            'e1d565d241a3a45793159a11f77a72946f6580224583da905324666ef6dd73fa'
            'e0937e247290fe2e62205d247ab6f12b430e23a1dc7d6b699a68a0f8fb652d93'
            '81ff05ab86d25e673a4783b2f5290c06a62e609e3c6d68d0214f23bed65dc5f7'
            '9802e695d74ae5e11438e2ca1b5d92924df74db88a7c5621f778c443912ec153'
            '1852a0b4f6003aec4ba5975c03c4d7613aa70bb1dbf2b3aebd73bc74b5e91ec9'
            'c1a80bb2010347fd7f33d3f73f9ded806470f3e373cf4be2da18189ee98574bc'
            'bbd1bfd12183dc55258f1b604703b8cd51caf8297a3500b64fca5a0621cd4920'
            '6402aac519e1b3f00368ab38aff0eb0a11529a6d01e5cd74cff8c8f7fdda6812'
            '44dc6923dc9612825cbb109f0bb572b21356be5a6376e0790463bf49eb460369'
            'ba169f46131a9c601f14e75dba16a68a43f0adc0109f8ea780df615c1d374624'
            '17ce4735a15fc76c12c87418476b7aacd0257db78ef530ad069fcd04bd4ee724'
            'd0ebefaadb1a9db9c84b695a7e4cee91e807017122398f325e01d1a3a2ba134f'
            '3b5f44256c2eb960fb9eaad1285033d56974a671b13948d2065aafeab5bdbf2a'
            'ce6f813b14e5cae7b625c8ebac01b350cbd715d73fedff0320ff1725f19d00c6'
            '291585dbc304e72ab49eb0e60836d75d48d91ae2dc6b862cb1e4bb926d0467f0'
            '269deddb42a3032d40212c179ad2d9db49e9fa59a414b74db5c5e56a8289b4a0'
            'c2a909dec712f75984c0b6e93e7c567613f96a3b6b41ded7097e03086a931dc4'
            '2633772ffdb02fbeaca133d941d49c140242b1e3f7c89f74b9c6977be74fbbb8'
            '8c57eba99332f9c86d69313855d91b513ad459847093fae074eb2418ea924a20'
            '4c565b945c02aeb5abf504961fb2838f388838a87fc1da0a390b9776d8b3d625'
            'a4070ca8582a1e4494d4a88a9ea5b81fd09557ed0485733be946cbd7b5475547'
            '5af046270d92bd0f2151e0d7f98e455bb893eccee3a6ab67c9932c2ac6ff1594'
            '8bdb0c37cea8df97fcbe0f79055ccb2d9a4e08df218d90ac7bbd06f3161977cf'
            '7d73c0bd3527f3deec6db7c77d371fb7eef4264c36481c768f0646e2c0813a81'
            'cd1a1690ba6ea68441a8159b32d03af58d48f65fa6ec9fc5ac106c679f6a4198'
            'c2e58c0a99cbbe853c386721d14a58920e2aea05ca66727c80e0741b5e7907dd'
            'f2a9f6d236be9dbee925e31ad9affe9fcd2a4aafe583ae79258c4bb434d4e164'
            'e20f554bfe1a270cc1e223e7f919d6fef52c417abc500468254660cd881baf49'
            '28c0b89bae42f2733e8458a42c13177ac91d9efca4ca7f310f759e385195f401'
            '28727c38823f48c2df82411891dffd3cb276e37b3480431323bcf1df3b229aca'
            'c9d09f4bed42abffd20265743f8d08bd8c4bd8aa8332a3895e51da06a3b30f3b'
            'd1ffdc5bad1beb899662873c9afdfc14250b01e846be80dbf621e52f7f9ef788'
            'afe39a173b0027505dbafe2db37c5967facff96f3a681f7b4608242d92f07ffa'
            'c7603d14c83741aeefcd256843dd689d27c2bdaa73c079a792c66753300e5de3'
            '64b60ac9fc29b5b88ff6d5d1363170e177517baac94798509ab425795efeaa3d'
            '7b969cec3021c3ae9677063ba4c19af2fbbdd3f02b7899716145f967d629cd3b'
            'cd09b5ae714bc78bef09ddc7740db0a2d703fc53bbea9215bda3baac5949754d'
            'b205dae270cb4ee54d7fd068f2b90f51986116defd45dd5cb999eae5901c67c2'
            '044922111b585804c20c22213d774cc7ed9b0bb77d562ddfa432baf7e9a7d63d')
prepare() {
  cd "${srcdir}"/msys2-runtime
  git am --committer-date-is-author-date "${srcdir}"/0001-Add-MSYS-triplets.patch
  git am --committer-date-is-author-date "${srcdir}"/0002-Rename-DLL-from-cygwin-to-msys.patch
  git am --committer-date-is-author-date "${srcdir}"/0003-Add-functionality-for-converting-UNIX-paths-in-argum.patch
  git am --committer-date-is-author-date "${srcdir}"/0004-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
  git am --committer-date-is-author-date "${srcdir}"/0005-Move-root-to-usr.-Change-sorting-mount-points.-Do-no.patch
  git am --committer-date-is-author-date "${srcdir}"/0006-Do-not-create-cygwin-symlinks.-Instead-use-deep-copy.patch
  git am --committer-date-is-author-date "${srcdir}"/0007-Automatically-rewrite-TERM-msys-to-TERM-cygwin.patch
  git am --committer-date-is-author-date "${srcdir}"/0008-Do-not-convert-environment-for-strace.patch
  git am --committer-date-is-author-date "${srcdir}"/0009-convert-be-more-careful-to-stay-within-the-buffer.patch
  git am --committer-date-is-author-date "${srcdir}"/0010-convert-check-safely-whether-we-could-allocate-the-b.patch
  git am --committer-date-is-author-date "${srcdir}"/0011-convert-use-the-elegant-realloc-call.patch
  git am --committer-date-is-author-date "${srcdir}"/0012-convert-plug-potential-memory-leak.patch
  git am --committer-date-is-author-date "${srcdir}"/0013-convert-warn-when-we-cut-off-a-path.patch
  git am --committer-date-is-author-date "${srcdir}"/0014-arg_heuristic-be-better-prepared-to-handle-path-list.patch
  git am --committer-date-is-author-date "${srcdir}"/0015-Fix-converting-argument-looks-like-DVAR-str1-c-path1.patch
  git am --committer-date-is-author-date "${srcdir}"/0016-Special-case-for-converting-root-directory-to-have-t.patch
  git am --committer-date-is-author-date "${srcdir}"/0017-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
  git am --committer-date-is-author-date "${srcdir}"/0018-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
  git am --committer-date-is-author-date "${srcdir}"/0019-strace.cc-Don-t-set-MSYS-noglob.patch
  git am --committer-date-is-author-date "${srcdir}"/0020-Add-debugging-for-build_argv.patch
  git am --committer-date-is-author-date "${srcdir}"/0021-Add-debugging-for-strace-make_command_line.patch
  git am --committer-date-is-author-date "${srcdir}"/0022-environ.cc-New-facility-environment-variable-MSYS2_E.patch
  git am --committer-date-is-author-date "${srcdir}"/0023-Pass-the-TZ-variable-to-non-msys-programs-if-it-is-s.patch
  git am --committer-date-is-author-date "${srcdir}"/0024-Pass-environment-variables-with-empty-values.patch
  git am --committer-date-is-author-date "${srcdir}"/0025-Handle-8-bit-characters-under-LOCALE-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0026-path.cc-Ignore-zero-length-exclusions.patch
  git am --committer-date-is-author-date "${srcdir}"/0027-Mention-the-extremely-useful-small_printf-function.patch
  git am --committer-date-is-author-date "${srcdir}"/0028-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
  git am --committer-date-is-author-date "${srcdir}"/0029-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
  git am --committer-date-is-author-date "${srcdir}"/0030-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
  git am --committer-date-is-author-date "${srcdir}"/0031-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0032-Leave-Git-s-name-and-message-arguments-alone-please.patch
  git am --committer-date-is-author-date "${srcdir}"/0033-Leave-paths-containing-any-special-characters-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0034-Leave-paths-containing-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0035-Skip-posix-to-windows-conversion-when-is-seen.patch
  git am --committer-date-is-author-date "${srcdir}"/0036-Also-leave-Git-s-rev-.-name-syntax-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0037-Arguments-starting-with-are-no-paths.patch
  git am --committer-date-is-author-date "${srcdir}"/0038-Prevent-scp-style-arguments-from-being-mangled.patch
  git am --committer-date-is-author-date "${srcdir}"/0039-Fixed-path-converting-with-non-ascii-char.patch
  git am --committer-date-is-author-date "${srcdir}"/0040-path-conversion-Introduce-ability-to-switch-off-conv.patch
  git am --committer-date-is-author-date "${srcdir}"/0041-Kill-also-children-of-the-process-to-be-killed-via-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0042-Export-the-kill_process_tree-function.patch
  git am --committer-date-is-author-date "${srcdir}"/0043-kill-Handle-Win32-console-processes-children-too.patch
  git am --committer-date-is-author-date "${srcdir}"/0044-Allow-overriding-the-home-directory-via-the-HOME-var.patch
  git am --committer-date-is-author-date "${srcdir}"/0045-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
  git am --committer-date-is-author-date "${srcdir}"/0046-Respect-the-db_home-env-setting-under-more-circumsta.patch
  git am --committer-date-is-author-date "${srcdir}"/0047-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
  git am --committer-date-is-author-date "${srcdir}"/0048-POSIX-ify-the-SHELL-variable.patch
  git am --committer-date-is-author-date "${srcdir}"/0049-Make-paths-WCS-MBS-conversion-explicit.patch
  git am --committer-date-is-author-date "${srcdir}"/0050-Handle-ORIGINAL_PATH-just-like-PATH.patch
}

build() {
  [[ -d "${srcdir}"/build-${CHOST} ]] && rm -rf "${srcdir}"/build-${CHOST}
  mkdir -p "${srcdir}"/build-${CHOST} && cd "${srcdir}"/build-${CHOST}

  # Gives more verbose compile output when debugging.
  local -a extra_config
  if check_option "debug" "y"; then
    export CCWRAP_VERBOSE=1
    OPTIM="-O0"
    extra_config+=(--enable-debugging)
  else
    OPTIM="-O2"
  fi

  CFLAGS="$OPTIM -pipe -ggdb -Wno-error=frame-address -fno-delete-null-pointer-checks"
  CXXFLAGS="$OPTIM -pipe -ggdb -Wno-error=frame-address -fno-delete-null-pointer-checks"

  "${srcdir}"/msys2-runtime/configure \
    --prefix=/usr \
    --build=${CHOST} \
    --sysconfdir=/etc \
    "${extra_config[@]}"
  LC_ALL=C make
  LC_ALL=C make -j1 DESTDIR="${srcdir}"/dest install

  #pushd ${CHOST}/winsup/cygwin > /dev/null
  #LANG=C make libmsys2_s.a
  #cp libmsys2_s.a "${srcdir}"/dest/usr/${CHOST}/lib/
  #popd > /dev/null

  rm -rf "${srcdir}"/dest/etc
}

package_msys2-runtime() {
  pkgdesc="Posix emulation engine for Windows"
  groups=('base')
  options=('!strip')
  #install=msys2-runtime.install

  mkdir -p "${pkgdir}"/usr
  cp -rf "${srcdir}"/dest/usr/bin "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/bin/msys-2.0.dbg
  rm -f "${pkgdir}"/usr/bin/cyglsa-config
  rm -f "${pkgdir}"/usr/bin/cyglsa.dll
  rm -f "${pkgdir}"/usr/bin/cyglsa64.dll
  rm -f "${pkgdir}"/usr/bin/cygserver-config
  cp -rf "${srcdir}"/dest/usr/share "${pkgdir}"/usr/
}

package_msys2-runtime-devel() {
  pkgdesc="MSYS2 headers and libraries"
  groups=('MSYS2-devel')
  depends=("msys2-runtime=${pkgver}")
  options=('staticlibs' '!strip')

  mkdir -p "${pkgdir}"/usr/bin
  cp -f "${srcdir}"/dest/usr/bin/msys-2.0.dbg "${pkgdir}"/usr/bin/
  cp -rLf "${srcdir}"/dest/usr/${CHOST}/include "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/include/iconv.h
  rm -f "${pkgdir}"/usr/include/unctrl.h
  # provided by libtirpc
  rm -fr "${pkgdir}"/usr/include/rpc/

  cp -rLf "${srcdir}"/dest/usr/${CHOST}/lib "${pkgdir}"/usr/
}

# return 0
# To hack on this:
# cd /c/repo-MSYS2/msys2-runtime/
# pushd src/build-i686-pc-msys
# LANG=C make && make -j1 DESTDIR=/c/repo-MSYS2/msys2-runtime/src/dest install
# popd
# makepkg -sRLf
# pacman -U msys2-runtime*.xz

# Quicker:
# open cmd.exe
# set "PATH=C:\\msys32\\usr\\bin;%PATH%"
# E:
# pushd E:\m2\repo-MSYS2\msys2-runtime\src\build-i686-pc-msys\i686-pc-msys\winsup\cygwin
# C:/msys32/usr/bin/bash -c "LANG=C && make"
# copy /y new-msys-2.0.dll C:\msys32\usr\bin\msys-2.0.dll
# popd
# C:
# C:/msys32/usr/bin/strace ls / > C:/strace.txt 2>&1
#
