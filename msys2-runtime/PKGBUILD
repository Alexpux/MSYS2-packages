# Maintainer: Alexey Pavlov <alexpux@gmail.com>
# Contributor: Ray Donnelly <mingw.android@gmail.com>

pkgbase=msys2-runtime
pkgname=('msys2-runtime' 'msys2-runtime-devel')
pkgver=2.8.1
pkgrel=1
pkgdesc="Cygwin POSIX emulation engine"
arch=('i686' 'x86_64')
url="https://www.cygwin.com/"
license=('GPL')
groups=('base')
makedepends=('cocom'
             'texinfo'
             'git'
             'perl'
             'gcc'
             'make'
             'mingw-w64-cross-gcc'
             'mingw-w64-cross-zlib'
             'zlib-devel'
             'gettext-devel'
             'libiconv-devel'
             'diffutils')
# options=('debug' '!strip')
source=('msys2-runtime'::git://sourceware.org/git/newlib-cygwin.git#tag=cygwin-${pkgver//./_}-release
        0001-Add-MSYS-triplets.patch
        0002-Rename-DLL-from-cygwin-to-msys.patch
        0003-Add-functionality-for-converting-UNIX-paths-in-argum.patch
        0004-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
        0005-Move-root-to-usr.-Change-sorting-mount-points.-Do-no.patch
        0006-Do-not-create-cygwin-symlinks.-Instead-use-deep-copy.patch
        0007-Automatically-rewrite-TERM-msys-to-TERM-cygwin.patch
        0008-Do-not-convert-environment-for-strace.patch
        0009-convert-be-more-careful-to-stay-within-the-buffer.patch
        0010-convert-check-safely-whether-we-could-allocate-the-b.patch
        0011-convert-use-the-elegant-realloc-call.patch
        0012-convert-plug-potential-memory-leak.patch
        0013-convert-warn-when-we-cut-off-a-path.patch
        0014-arg_heuristic-be-better-prepared-to-handle-path-list.patch
        0015-Fix-converting-argument-looks-like-DVAR-str1-c-path1.patch
        0016-Special-case-for-converting-root-directory-to-have-t.patch
        0017-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
        0018-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
        0019-strace.cc-Don-t-set-MSYS-noglob.patch
        0020-Add-debugging-for-build_argv.patch
        0021-Add-debugging-for-strace-make_command_line.patch
        0022-environ.cc-New-facility-environment-variable-MSYS2_E.patch
        0023-Pass-the-TZ-variable-to-non-msys-programs-if-it-is-s.patch
        0024-path.cc-Ignore-zero-length-exclusions.patch
        0025-Pass-environment-variables-with-empty-values.patch
        0026-Handle-8-bit-characters-under-LOCALE-C.patch
        0027-Mention-the-extremely-useful-small_printf-function.patch
        0028-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
        0029-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
        0030-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
        0031-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
        0032-Leave-Git-s-name-and-message-arguments-alone-please.patch
        0033-Leave-paths-containing-any-special-characters-alone.patch
        0034-Leave-paths-containing-alone.patch
        0035-Skip-posix-to-windows-conversion-when-is-seen.patch
        0036-Also-leave-Git-s-rev-.-name-syntax-alone.patch
        0037-Arguments-starting-with-are-no-paths.patch
        0038-Prevent-scp-style-arguments-from-being-mangled.patch
        0039-Fixed-path-converting-with-non-ascii-char.patch
        0040-path-conversion-Introduce-ability-to-switch-off-conv.patch
        0041-Try-to-kill-Win32-processes-gently-upon-Ctrl-C.patch
        0042-kill-kill-Win32-processes-more-gently.patch
        0043-Allow-overriding-the-home-directory-via-the-HOME-var.patch
        0044-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
        0045-Respect-the-db_home-env-setting-under-more-circumsta.patch
        0046-POSIX-ify-the-SHELL-variable.patch
        0047-Make-paths-WCS-MBS-conversion-explicit.patch
        0048-Handle-ORIGINAL_PATH-just-like-PATH.patch
        0049-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
        0050-Avoid-comparing-this-to-NULL.patch
        0051-Avoid-assert-this-statements.patch)
sha256sums=('SKIP'
            '53bef7f6302d3cbd226f49aa3d5dffab493571ca4de95fcef647bee6440a1235'
            '29ae6b5dad8ba8a77113bde01cf5ac406ea4912658cf22ad953fb0a6ee82ba83'
            '2ea473a4e4a62e993696feab2f0c6547be265208a1acd5aba73be6d4b2ce4917'
            '8b361f87c0f7530da5a9444b371898603535b8ceea6863e2b5c02304200f5876'
            'be9ff2702ed1f1a5686c1a0d5d8e2e8ed03323ed57ea912639509ecd46e23ab4'
            '3dc0fcf60f0a603deb1eae49620be7aa1a494b9c37658521df0245ffc07a20fc'
            '412b4eb55ab85af8068b151a1c6c77c362a4693432495d8e97d1fe865c24aa18'
            'f9edfb77cbc93155d269cdadb9d311df8d6ebab7da12f2c46fdd0a89bec278fc'
            'd7ca5608e81fd6ee5040080163d137d93dfad53da4ebfa30c75cd06e5fed4b43'
            'da3a55f94fb40974ba0b769d43556a83d44833f57819356197f094558db700ed'
            'aa1acd919c874364efc3c16e5fa8b6b1a3a98843236bf7e4df7df69f562d150b'
            '1179fa96595bc9e70cfdb8e0c3cb229f4c74c3e68b1fc87c5c7998fde9cc3128'
            '49f9692aa63075f2deb2d03df9dde91ecd82628e2dc61c73fa099b5d031c3752'
            'db33612e3d1d54da5bd70b3040e2369e69c8ddb1246be188d5dd5101c1600b52'
            '2e2f77a200343ae9eb43cf514be1ade7b8c62814ae191a8f11fc9303d84eaf71'
            '57b0681a758a03133dbecc78e94476b327dc6eb06443e635ae07778c3a98e9e6'
            '248e2a860d900c94615e665075cd156ef7215a0c01dcf8c87393950df98f9bbf'
            '9ee4ef6b1ed709b5947c29fbb537936a24cd3830eeca177aa7b3ee2c17a528b6'
            '85d31cb4e9e8233e4c9f3b46e096e57df2c8db88c98b6af65384b8b121b0a56e'
            '5b9fb3262db801490b74c96c1634f3751262ed4c5ada9256350db64ccd541b59'
            '03b511e7f876d3be6d3d5e041337018c4e1f7bcb7ac0c5f18e0421793f3d9060'
            'cc3a6d62bd5154aff6849009427dcd8645c3fd840f681364cfff0b32bbe5682b'
            '5e45e1f635a4c43731499d71efdb54953cb62f6d344e7d1b437d9f7107c14c8a'
            '916e0655a110911ebf7ac003b5337c72fd6d56a5aefe8e8594000849ae1573b0'
            'a65156263dfeb8eee276a0c7b939a514ac22bcce926f292b8276a074b8ede935'
            '93bdfd04cd11630cc5dd0eed26592be43e8f3c902bdcc0beb51f80ffd23774cf'
            '709cd3c92471e79d5b73d64ea8c7d78c8459ed7145ac08be2f36e127c5ebbc38'
            'df592b505346c400542e9372876f827d08b4edfdd5c45ad3fa4f33f786ffbeef'
            '074cab791524bad1598ff37fd47b0eea85025762b6ab3b457b1543101ac8db52'
            '94ed1827f5ff6d834a88383ea107a0ddef8d8622700dcc7575858a4d5fd585c8'
            '4801cf8111f303327f812323ffaa730ae133c479d8798d7171df88f14185bee1'
            '6836fa7dad2e205fd79672ad441c0194f00468e9dbecfc03a56de2c0ed08ce3c'
            'b7c299fb02ca7a193773f767884558da26c29fbbd6c2bc09dfedd7f5095233b6'
            '34675c6122ce67013387fde6f1fca8ae054c63d9bf4198aee02cfab94a0594db'
            '69fcb4a4fdb053a03fbfe0338c9d68002bb73a7f360f09ed45a5ef4fabbebe47'
            'a80d20ddf956cbb8c1fe503203c248440e603cca5d4c4594075dc68330a0bd2d'
            'd40ed3b19e468f73c19e35ae0e8fc73aac4a7e6db9f060d9feb447c329a33a08'
            '8411d6ae6641e4b9efd4fe1bb6a4eed8878f1fe71832562815b5a845ce298487'
            'f1c9178644a574dc16f4f3b8820a292c2d5ef7f47d175a1d582e247a5b092620'
            'f146747fd0166f7cca88df57872eeea9fa2126d58e89b071a8db28f5ab17f29f'
            'b048e2a3d04e33c6bc7aeaca80d11788a573073ec5beb234b3745e95a33ebfaa'
            '3864de341fb1d5ed33bd021949d985755a5c571e2e86559eadbd7cc83de9eef2'
            '970ccc7d7f288ee42473ee30399ec34ad348174ff7337325d41ee66f41cb01c6'
            'bf872089f94ce09ebe57fa5dc1ebb6ae927326f84fcbd4496067af4453b56c27'
            '089ceb23a0feb35c7d94183cca748fcc501dc671258d1f29606389ec02710989'
            '7ae0869cf2b6a02917c57e9d68d37ff272d11cdad66c908c9856dac8ab26b342'
            '6f27029782c3afc06fb23f6dfcd2a136c0726c71584bd90ec929d07c74f9c213'
            'ea1cc2b5b42479121e524c64506ea6d874e11c148408ad6fc2222b573d8a1492'
            'b756285129a72628c5faab1d9ec11ff0ed503f879d8e80b825c16a6bcc7d58da'
            'e17ae19235173809a10167731943c20bcdca15c51ecb9bde699504841bb667d8'
            '07bde1b896387cc4e6b3c297272433eaec849201285f20ef7062b9a99ede2dd9')
prepare() {
  cd "${srcdir}"/msys2-runtime
  git am --committer-date-is-author-date "${srcdir}"/0001-Add-MSYS-triplets.patch
  git am --committer-date-is-author-date "${srcdir}"/0002-Rename-DLL-from-cygwin-to-msys.patch
  git am --committer-date-is-author-date "${srcdir}"/0003-Add-functionality-for-converting-UNIX-paths-in-argum.patch
  git am --committer-date-is-author-date "${srcdir}"/0004-Add-functionality-for-changing-OS-name-via-MSYSTEM-e.patch
  git am --committer-date-is-author-date "${srcdir}"/0005-Move-root-to-usr.-Change-sorting-mount-points.-Do-no.patch
  git am --committer-date-is-author-date "${srcdir}"/0006-Do-not-create-cygwin-symlinks.-Instead-use-deep-copy.patch
  git am --committer-date-is-author-date "${srcdir}"/0007-Automatically-rewrite-TERM-msys-to-TERM-cygwin.patch
  git am --committer-date-is-author-date "${srcdir}"/0008-Do-not-convert-environment-for-strace.patch
  git am --committer-date-is-author-date "${srcdir}"/0009-convert-be-more-careful-to-stay-within-the-buffer.patch
  git am --committer-date-is-author-date "${srcdir}"/0010-convert-check-safely-whether-we-could-allocate-the-b.patch
  git am --committer-date-is-author-date "${srcdir}"/0011-convert-use-the-elegant-realloc-call.patch
  git am --committer-date-is-author-date "${srcdir}"/0012-convert-plug-potential-memory-leak.patch
  git am --committer-date-is-author-date "${srcdir}"/0013-convert-warn-when-we-cut-off-a-path.patch
  git am --committer-date-is-author-date "${srcdir}"/0014-arg_heuristic-be-better-prepared-to-handle-path-list.patch
  git am --committer-date-is-author-date "${srcdir}"/0015-Fix-converting-argument-looks-like-DVAR-str1-c-path1.patch
  git am --committer-date-is-author-date "${srcdir}"/0016-Special-case-for-converting-root-directory-to-have-t.patch
  git am --committer-date-is-author-date "${srcdir}"/0017-dcrt0.cc-Untangle-allow_glob-from-winshell.patch
  git am --committer-date-is-author-date "${srcdir}"/0018-dcrt0.cc-globify-Don-t-quote-literal-strings-differe.patch
  git am --committer-date-is-author-date "${srcdir}"/0019-strace.cc-Don-t-set-MSYS-noglob.patch
  git am --committer-date-is-author-date "${srcdir}"/0020-Add-debugging-for-build_argv.patch
  git am --committer-date-is-author-date "${srcdir}"/0021-Add-debugging-for-strace-make_command_line.patch
  git am --committer-date-is-author-date "${srcdir}"/0022-environ.cc-New-facility-environment-variable-MSYS2_E.patch
  git am --committer-date-is-author-date "${srcdir}"/0023-Pass-the-TZ-variable-to-non-msys-programs-if-it-is-s.patch
  git am --committer-date-is-author-date "${srcdir}"/0024-path.cc-Ignore-zero-length-exclusions.patch
  git am --committer-date-is-author-date "${srcdir}"/0025-Pass-environment-variables-with-empty-values.patch
  git am --committer-date-is-author-date "${srcdir}"/0026-Handle-8-bit-characters-under-LOCALE-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0027-Mention-the-extremely-useful-small_printf-function.patch
  git am --committer-date-is-author-date "${srcdir}"/0028-Add-a-helpful-debug-message-for-posix-to-windows-con.patch
  git am --committer-date-is-author-date "${srcdir}"/0029-Stop-assuming-that-there-are-no-spaces-in-POSIX-styl.patch
  git am --committer-date-is-author-date "${srcdir}"/0030-Avoid-unnecessary-recursion-in-find_path_start_and_t.patch
  git am --committer-date-is-author-date "${srcdir}"/0031-Leave-arguments-starting-with-a-tilde-or-quote-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0032-Leave-Git-s-name-and-message-arguments-alone-please.patch
  git am --committer-date-is-author-date "${srcdir}"/0033-Leave-paths-containing-any-special-characters-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0034-Leave-paths-containing-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0035-Skip-posix-to-windows-conversion-when-is-seen.patch
  git am --committer-date-is-author-date "${srcdir}"/0036-Also-leave-Git-s-rev-.-name-syntax-alone.patch
  git am --committer-date-is-author-date "${srcdir}"/0037-Arguments-starting-with-are-no-paths.patch
  git am --committer-date-is-author-date "${srcdir}"/0038-Prevent-scp-style-arguments-from-being-mangled.patch
  git am --committer-date-is-author-date "${srcdir}"/0039-Fixed-path-converting-with-non-ascii-char.patch
  git am --committer-date-is-author-date "${srcdir}"/0040-path-conversion-Introduce-ability-to-switch-off-conv.patch
  git am --committer-date-is-author-date "${srcdir}"/0041-Try-to-kill-Win32-processes-gently-upon-Ctrl-C.patch
  git am --committer-date-is-author-date "${srcdir}"/0042-kill-kill-Win32-processes-more-gently.patch
  git am --committer-date-is-author-date "${srcdir}"/0043-Allow-overriding-the-home-directory-via-the-HOME-var.patch
  git am --committer-date-is-author-date "${srcdir}"/0044-Respect-db_home-setting-even-for-the-SYSTEM-account.patch
  git am --committer-date-is-author-date "${srcdir}"/0045-Respect-the-db_home-env-setting-under-more-circumsta.patch
  git am --committer-date-is-author-date "${srcdir}"/0046-POSIX-ify-the-SHELL-variable.patch
  git am --committer-date-is-author-date "${srcdir}"/0047-Make-paths-WCS-MBS-conversion-explicit.patch
  git am --committer-date-is-author-date "${srcdir}"/0048-Handle-ORIGINAL_PATH-just-like-PATH.patch
  git am --committer-date-is-author-date "${srcdir}"/0049-Allow-native-symlinks-to-non-existing-targets-in-nat.patch
  git am --committer-date-is-author-date "${srcdir}"/0050-Avoid-comparing-this-to-NULL.patch
  git am --committer-date-is-author-date "${srcdir}"/0051-Avoid-assert-this-statements.patch
}

build() {
  [[ -d "${srcdir}"/build-${CHOST} ]] && rm -rf "${srcdir}"/build-${CHOST}
  mkdir -p "${srcdir}"/build-${CHOST} && cd "${srcdir}"/build-${CHOST}

  # Gives more verbose compile output when debugging.
  local -a extra_config
  if check_option "debug" "y"; then
    export CCWRAP_VERBOSE=1
    OPTIM="-O0"
    extra_config+=(--enable-debugging)
  else
    OPTIM="-O2"
  fi

  CFLAGS="$OPTIM -pipe -ggdb -Wno-error=frame-address -fno-delete-null-pointer-checks"
  CXXFLAGS="$OPTIM -pipe -ggdb -Wno-error=frame-address -fno-delete-null-pointer-checks"

  "${srcdir}"/msys2-runtime/configure \
    --prefix=/usr \
    --build=${CHOST} \
    --sysconfdir=/etc \
    "${extra_config[@]}"
  LC_ALL=C make
  LC_ALL=C make -j1 DESTDIR="${srcdir}"/dest install

  #pushd ${CHOST}/winsup/cygwin > /dev/null
  #LANG=C make libmsys2_s.a
  #cp libmsys2_s.a "${srcdir}"/dest/usr/${CHOST}/lib/
  #popd > /dev/null

  rm -rf "${srcdir}"/dest/etc
}

package_msys2-runtime() {
  pkgdesc="Posix emulation engine for Windows"
  groups=('base')
  options=('!strip')
  #install=msys2-runtime.install

  mkdir -p "${pkgdir}"/usr
  cp -rf "${srcdir}"/dest/usr/bin "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/bin/msys-2.0.dbg
  rm -f "${pkgdir}"/usr/bin/cyglsa-config
  rm -f "${pkgdir}"/usr/bin/cyglsa.dll
  rm -f "${pkgdir}"/usr/bin/cyglsa64.dll
  rm -f "${pkgdir}"/usr/bin/cygserver-config
  cp -rf "${srcdir}"/dest/usr/share "${pkgdir}"/usr/
}

package_msys2-runtime-devel() {
  pkgdesc="MSYS2 headers and libraries"
  groups=('MSYS2-devel')
  depends=("msys2-runtime=${pkgver}")
  options=('staticlibs' '!strip')

  mkdir -p "${pkgdir}"/usr/bin
  cp -f "${srcdir}"/dest/usr/bin/msys-2.0.dbg "${pkgdir}"/usr/bin/
  cp -rLf "${srcdir}"/dest/usr/${CHOST}/include "${pkgdir}"/usr/
  rm -f "${pkgdir}"/usr/include/iconv.h
  rm -f "${pkgdir}"/usr/include/unctrl.h
  # provided by libtirpc
  rm -fr "${pkgdir}"/usr/include/rpc/

  cp -rLf "${srcdir}"/dest/usr/${CHOST}/lib "${pkgdir}"/usr/
}

# return 0
# To hack on this:
# cd /c/repo-MSYS2/msys2-runtime/
# pushd src/build-i686-pc-msys
# LANG=C make && make -j1 DESTDIR=/c/repo-MSYS2/msys2-runtime/src/dest install
# popd
# makepkg -sRLf
# pacman -U msys2-runtime*.xz

# Quicker:
# open cmd.exe
# set "PATH=C:\\msys32\\usr\\bin;%PATH%"
# E:
# pushd E:\m2\repo-MSYS2\msys2-runtime\src\build-i686-pc-msys\i686-pc-msys\winsup\cygwin
# C:/msys32/usr/bin/bash -c "LANG=C && make"
# copy /y new-msys-2.0.dll C:\msys32\usr\bin\msys-2.0.dll
# popd
# C:
# C:/msys32/usr/bin/strace ls / > C:/strace.txt 2>&1
#
