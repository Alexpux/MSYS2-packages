# Maintainer: Alexey Pavlov <Alexpux@gmail.com>

pkgname=perl
pkgver=5.26.0
#don't hard code _gccver because the compiler might be upgraded later.
_gccver=$(gcc --version | grep ^gcc | sed 's/^.* //g')
pkgrel=1
pkgdesc="A highly capable, feature-rich programming language"
arch=(i686 x86_64)
license=('GPL')
url="https://www.perl.org/"
groups=('base-devel')
depends=('db' 'gdbm' 'libcrypt' 'coreutils' 'msys2-runtime' 'sh')
makedepends=('libdb-devel' 'libgdbm-devel' 'libcrypt-devel')
source=(https://www.cpan.org/src/5.0/perl-${pkgver}.tar.bz2
        perlbin.sh
        perlbin.csh
        perlbin.fish
        perl-binary-module-dependency-1.template
        perl.cygwin-auto-image-base.patch
        perl.cygwin-hints.patch
        perl.cygwin-Configure-libpth.patch
        perl.cygwin-Configure-libsearch.patch
        perl-5.26.0-msys2.patch
        regen-skip.diff
        test-suite-without-dot.diff
        regen-path.patch)
options=('makeflags' '!purge' 'emptydirs')
# NOTE: This array is automatically generated by `./patchprov`.
#       If you want to add entries, do so in the next array.
provides=('perl-archive-tar=2.24'
          'perl-attribute-handlers=0.99'
          'perl-autodie=2.29'
          'perl-autoloader=5.74'
          'perl-autouse=1.11'
          'perl-b-debug=1.24'
          'perl-base=2.25'
          'perl-bignum=0.47'
          'perl-carp=1.42'
          'perl-compress-raw-bzip2=2.074'
          'perl-compress-raw-zlib=2.074'
          'perl-config-perl-v=0.28'
          'perl-constant=1.33'
          'perl-cpan-meta-requirements=2.140'
          'perl-cpan-meta-yaml=0.018'
          'perl-cpan-meta=2.150010'
          'perl-cpan=2.18'
          'perl-data-dumper=2.167'
          'perl-db_file=1.840'
          'perl-devel-ppport=3.35'
          'perl-devel-selfstubber=1.06'
          'perl-digest-md5=2.55'
          'perl-digest-sha=5.96'
          'perl-digest=1.17_01'
          'perl-dumpvalue=1.18'
          'perl-encode=2.88'
          'perl-encoding-warnings=0.13'
          'perl-env=1.04'
          'perl-experimental=0.016'
          'perl-exporter=5.72'
          'perl-extutils-cbuilder=0.280225'
          'perl-extutils-constant=0.23'
          'perl-extutils-install=2.04'
          'perl-extutils-makemaker=7.24'
          'perl-extutils-manifest=1.70'
          'perl-extutils-parsexs=3.34'
          'perl-file-fetch=0.52'
          'perl-file-path=2.12_01'
          'perl-file-temp=0.2304'
          'perl-filter-simple=0.93'
          'perl-filter-util-call=1.55'
          'perl-getopt-long=2.49'
          'perl-http-tiny=0.070'
          'perl-i18n-collate=1.02'
          'perl-i18n-langtags=0.42'
          'perl-if=0.0606'
          'perl-io-compress=2.074'
          'perl-io-socket-ip=0.38'
          'perl-io-zlib=1.10'
          'perl-io=1.38'
          'perl-ipc-cmd=0.96'
          'perl-ipc-sysv=2.07'
          'perl-json-pp=2.27400_02'
          'perl-lib=0.64'
          'perl-libnet=3.10'
          'perl-locale-codes=3.42'
          'perl-locale-maketext-simple=0.21_01'
          'perl-locale-maketext=1.28'
          'perl-math-bigint-fastcalc=0.5005'
          'perl-math-bigint=1.999806'
          'perl-math-bigrat=0.2611'
          'perl-math-complex=1.5901'
          'perl-memoize=1.03_01'
          'perl-mime-base64=3.15'
          'perl-module-corelist=5.20170530'
          'perl-module-load-conditional=0.68'
          'perl-module-load=0.32'
          'perl-module-loaded=0.08'
          'perl-module-metadata=1.000033'
          'perl-net-ping=2.55'
          'perl-params-check=0.38'
          'perl-parent=0.236'
          'perl-pathtools=3.67'
          'perl-perl-ostype=1.010'
          'perl-perlfaq=5.021011'
          'perl-perlio-via-quotedprint=0.08'
          'perl-pod-checker=1.73'
          'perl-pod-escapes=1.07'
          'perl-pod-parser=1.63'
          'perl-pod-perldoc=3.28'
          'perl-pod-simple=3.35'
          'perl-pod-usage=1.69'
          'perl-podlators=5.006'
          'perl-safe=2.40'
          'perl-scalar-list-utils=1.46_02'
          'perl-search-dict=1.07'
          'perl-selfloader=1.23'
          'perl-socket=2.020_03'
          'perl-storable=2.62'
          'perl-sys-syslog=0.35'
          'perl-term-ansicolor=4.06'
          'perl-term-cap=1.17'
          'perl-term-complete=1.403'
          'perl-term-readline=1.16'
          'perl-test-harness=3.38'
          'perl-test-simple=1.302073'
          'perl-test=1.30'
          'perl-text-abbrev=1.02'
          'perl-text-balanced=2.03'
          'perl-text-parsewords=3.30'
          'perl-text-tabs=2013.0523'
          'perl-thread-queue=3.12'
          'perl-thread-semaphore=2.13'
          'perl-threads-shared=1.56'
          'perl-threads=2.15'
          'perl-tie-file=1.02'
          'perl-tie-refhash=1.39'
          'perl-time-hires=1.9741'
          'perl-time-local=1.25'
          'perl-time-piece=1.31'
          'perl-unicode-collate=1.19'
          'perl-unicode-normalize=1.25'
          'perl-version=0.9917'
          'perl-xsloader=0.27')
# Add your own provides here
provides=(${provides[@]})
sha256sums=('f21d66de84982175e95ad15fd8d0e22fed2cc2de7e4394f5d48dbe451be2f6f2'
            '91bf8a45a3f04f51fe0eca146a71e278d41dbde19ba60dabc1e41c4639477c07'
            '478a52dc440d5ca324f4c95238b39cc8c90d5d7d8d5601fa085ffef79fea04f4'
            '11ce66bcf4803b0bf27179a32ce53f41bcdfa967c4c0d54ac103dbc4951d18a3'
            'fe91f1de38af525cb82503feef553b71299c52ea52c01b1959143f48f4051ffa'
            'b09619d49c18ef8449fe6f42c97fd869089c8128c1e0b0679f17972d73cb6e51'
            'f5ceb0210479622d179ff138f386720538116b2672bb7e422568e8dd74de1f01'
            'f2367862beeb11b2a65f8e5ef6cb0f622b016bc37535664d09abd5cbe562f688'
            'c4f2636a3673496d20fb21dbb8333b1d6bcf9f43adc3c5279e7f35791ea890a7'
            '69822c67ebe7327725ac6cea1769d5366050ff75b9b1fc6777e0856eaef6cf1e'
            'f2f28c33743f767e98a5c6b2666a838ed12590d913b02b2baf3258d6c175dc06'
            'ffd3a636cd0927c942cdee3f9c882101bbbf647008570d148a5cdf48590043e6'
            '01a56f24f95f109c538c70f2a1dec6466961a1bbec41ef4a50b05ad3516f1a09')

# Helper macros to help make tasks easier #
apply_patch_with_msg() {
  for _patch in "$@"
  do
    msg2 "Applying $_patch"
    patch -Nbp1 -i "${srcdir}/$_patch"
  done
}

apply_patch_with_p2_msg() {
  for _patch in "$@"
  do
    msg2 "Applying $_patch"
    patch -Nbp2 -i "${srcdir}/$_patch"
  done
}

del_file_exists() {
  for _fname in "$@"
  do
    if [ -f $_fname ]; then
      rm -rf $_fname
    fi
  done
}
# =========================================== #


prepare() {
  chmod -R 0666 ${srcdir}/${pkgname}-${pkgver}
  cd ${srcdir}/${pkgname}-${pkgver}

  del_file_exists hints/msys.sh \
      dist/ExtUtils-CBuilder/lib/ExtUtils/CBuilder/Platform/msys.pm 

  apply_patch_with_p2_msg perl.cygwin-auto-image-base.patch
  apply_patch_with_msg perl.cygwin-hints.patch 
  apply_patch_with_p2_msg  perl.cygwin-Configure-libsearch.patch \
    perl.cygwin-Configure-libpth.patch
  apply_patch_with_msg perl-5.26.0-msys2.patch

  #sed -i 's#version vutil.c .*#version vutil.c f1c7e4778fcf78c04141f562b80183b91cbbf6c9#' t/porting/customized.dat

  #fedora
  
  #debian
  apply_patch_with_msg regen-skip.diff test-suite-without-dot.diff 
  
  #perl
#  apply_patch_with_msg regen-path.patch
  cat > Policy.sh <<_EOF
#!/bin/sh
d_readlink='undef'
_EOF

sed -ri '/\s+$/s///' $(find . -type f | grep -vE ".ico$|.tgz$|.tbz$|.tar$|.utf$|.enc$|.patch$|.pub$")

}

build() {
  cd ${srcdir}/${pkgname}-${pkgver}

  ./Configure -des -Dusethreads \
    -Doptimize="${CFLAGS}" \
    -Dprefix=/usr \
    -Dvendorprefix=/usr \
    -Dprivlib=/usr/share/perl5/core_perl \
    -Darchlib=/usr/lib/perl5/core_perl \
    -Dsitelib=/usr/share/perl5/site_perl \
    -Dsitearch=/usr/lib/perl5/site_perl \
    -Dvendorlib=/usr/share/perl5/vendor_perl \
    -Dvendorarch=/usr/lib/perl5/vendor_perl \
    -Dscriptdir=/usr/bin/core_perl \
    -Dsitescript=/usr/bin/site_perl \
    -Dvendorscript=/usr/bin/vendor_perl \
    -Dinc_version_list=none \
    -Dman1ext=1perl -Dman3ext=3perl \
    -Darchname=${ARCH}-msys-threads \
    -Dmyarchname=${ARCH}-msys \
    -Dlibperl=msys-perl5_26.dll \
    -Dcc=gcc -Dld=g++ \
    -Accflags="$CFLAGS -fwrapv"

  LC_ALL=C make
}

check() {
  cd ${srcdir}/${pkgname}-${pkgver}
#  cp msys-perl5_26.dll t
  TEST_JOBS=$(echo $MAKEFLAGS | sed 's/.*-j\([0-9][0-9]*\).*/\1/') make test_harness || true
  #make test
}

package() {
  cd ${srcdir}/${pkgname}-${pkgver}
  make DESTDIR="${pkgdir}" install

  for template in "${srcdir}/"*.template; do
    install -Dm644 "${template}" "${pkgdir}/usr/share/makepkg-template/${template##*/}"
  done
  ln -s perl-binary-module-dependency-1.template "${pkgdir}/usr/share/makepkg-template/"perl-binary-module-dependency.template

  ### Perl Settings ###
  # Change man page extensions for site and vendor module builds.
  # Set no mail address since bug reports should go to the bug tracker
  # and not someone's email.
  sed -e '/^man1ext=/ s/1perl/1p/' -e '/^man3ext=/ s/3perl/3pm/' \
      -e "/^cf_email=/ s/'.*'/''/" \
      -e "/^perladmin=/ s/'.*'/''/" \
      -i ${pkgdir}/usr/lib/perl5/core_perl/Config_heavy.pl

  ### CPAN Settings ###
  # Set CPAN default config to use the site directories.
  sed -e '/(makepl_arg =>/   s/""/"INSTALLDIRS=site"/' \
      -e '/(mbuildpl_arg =>/ s/""/"installdirs=site"/' \
      -i ${pkgdir}/usr/share/perl5/core_perl/CPAN/FirstTime.pm

  # Profile script to set paths to perl scripts.
  install -D -m755 ${srcdir}/perlbin.sh \
                   ${pkgdir}/etc/profile.d/perlbin.sh
  # Profile script to set paths to perl scripts on csh. (FS#22441)
  install -D -m755 ${srcdir}/perlbin.csh \
                  ${pkgdir}/etc/profile.d/perlbin.csh
  # Profile script to set paths to perl scripts on fish. (FS#51191)
  install -D -m755 ${srcdir}/perlbin.fish \
                  ${pkgdir}/usr/share/fish/vendor_conf.d/perlbin.fish

  # Add the dirs so new installs will already have them in PATH once they
  # install their first perl programm
  install -d -m755 "${pkgdir}/usr/bin/vendor_perl"
  install -d -m755 "${pkgdir}/usr/bin/site_perl"

  #(cd ${pkgdir}/usr/bin; mv perl${pkgver} perl)
#  (cd ${pkgdir}/usr/bin/core_perl;  ln -sf corelist cpan enc2xs encguess h2ph h2xs instmodsh json_pp libnetcfg \
#       perlbug perldoc perlivp perlthanks piconv pl2pm pod2html pod2man pod2text pod2usage podchecker podselect \
#       prove ptar ptardiff ptargrep shasum splain xsubpp zipdetails ;)

  for script in \
      corelist cpan enc2xs encguess h2ph h2xs instmodsh \
      json_pp libnetcfg perlbug perldoc perlivp \
      perlthanks piconv pl2pm pod2html pod2man pod2text \
      pod2usage podchecker podselect prove ptar ptardiff ptargrep shasum \
      splain xsubpp zipdetails ; do
      ln -s ${pkgdir}/usr/bin/core_perl/${script} ${pkgdir}/usr/bin/${script}
  done

  # Remove all pod files *except* those under /usr/lib/perl5/core_perl/pods/
  # (FS#16488)
  rm -f ${pkgdir}/usr/share/perl5/core_perl/*.pod
  for d in ${pkgdir}/usr/share/perl5/core_perl/*; do
    if [ -d ${d} -a $(basename ${d}) != "pods" ]; then
      find ${d} -name *.pod -delete
    fi
  done
  find ${pkgdir}/usr/lib -name *.pod -delete
  find ${pkgdir} -name .packlist -delete

  find ${pkgdir}/usr/lib -type f -exec chmod 0644 {} \;
  find ${pkgdir}/usr/share/perl5 -type f -exec chmod 0644 {} \;
  # prevent xsinit-generated code from referencing boot_Win32CORE
  sed -i -e "s/^\(static_ext\)=.*/\1=' '/" \
    ${pkgdir}/usr/lib/perl5/core_perl/Config_heavy.pl
	
  install -D -m755 ${srcdir}/${pkgname}-${pkgver}/lib/auto/XS/APItest/APItest.dll \
                  ${pkgdir}/usr/lib/perl5/core_perl/auto/XS/APItest/APItest.dll
  install -D -m755 ${srcdir}/${pkgname}-${pkgver}/lib/auto/XS/Typemap/Typemap.dll \
                  ${pkgdir}/usr/lib/perl5/core_perl/auto/XS/Typemap/Typemap.dll
  install -D -m755 ${srcdir}/${pkgname}-${pkgver}/lib/auto/Win32CORE/Win32CORE.a \
                  ${pkgdir}/usr/lib/perl5/core_perl/auto/Win32CORE/Win32CORE.a

}
